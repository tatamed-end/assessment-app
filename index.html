<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地域支援個別訪問 アセスメントシステム</title>
    <!-- PWA機能に必要なマニフェストファイルへのリンクを追加 -->
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #e0e7ff; /* スライドデザインの色合い */
            color: #1f2937;
            padding-top: 20px;
            padding-bottom: 20px;
        }

        /* ----------------------------------
           ビューコンテナの共通スタイル
        ----------------------------------- */
        .view-container {
            min-height: calc(100vh - 40px);
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
            background-color: #f3f4f6; /* スライドデザインの色合い */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: none;
            border-radius: 12px;
            position: relative;
        }
        
        /* ----------------------------------
           表紙専用スタイル
        ----------------------------------- */
        #cover-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .title-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            width: 100%;
        }

        .title-icon {
            font-size: 80px;
            color: #4338ca; /* Indigo-700 */
            background: #e0e7ff;
            width: 160px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-bottom: 20px;
        }

        .main-title {
            color: #4338ca;
            font-weight: 700;
            font-size: 48px;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .nav-simulation {
            display: flex;
            gap: 20px;
            margin-top: 40px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-item {
            background: #4338ca;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            min-width: 160px;
        }

        .nav-item:hover {
            transform: translateY(-2px);
            background-color: #3730a3;
        }

        .date-subtitle {
            color: #4b5563;
            font-size: 24px;
            margin-top: 40px;
            font-family: monospace;
        }
        
        /* ----------------------------------
           評価シート専用のスタイル
        ----------------------------------- */
        .assessment-sheet {
            width: 100%;
            padding: 20px 0;
            box-sizing: border-box;
        }

        /* 項目を次の項目へ移動させるためのスタイルとタブインデックス */
        .tab-input {
            /* 画面上では背景色を透明に戻して、入力に集中しやすく */
            background: transparent !important;
        }

        /* 全ての入力フィールドの基本スタイル */
        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%;
            height: 100%;
            background: transparent;
            padding: 2px 4px;
            font-size: 14px;
            outline: none;
            text-align: center;
            border: none;
        }
        
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus {
            /* 入力時に背景を薄く色付けしてアクティブであることを示す */
            background-color: #f0f9ff;
        }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .input-underline {
            border-bottom: 1px solid #000;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #000;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #000;
            padding: 4px;
            font-size: 13px;
            vertical-align: middle;
            text-align: center;
        }

        th {
            background-color: #e5e7eb;
            font-weight: 700;
        }

        .cell-label {
            text-align: center;
            font-weight: 500;
        }

        .input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        /* ----------------------------------
           データベースグリッドのスタイル
        ----------------------------------- */
        .data-grid-container-style {
            margin-top: 20px;
            max-height: 70vh; 
            overflow-y: auto;
        }
        .data-grid-style {
            width: 100%;
            overflow-x: auto;
            border: 1px solid #d1d5db;
        }
        .data-grid-style table {
            min-width: 1500px;
            border: none;
        }
        .data-grid-style th, .data-grid-style td {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            white-space: nowrap;
            font-size: 12px;
            text-align: center;
            vertical-align: middle;
            min-width: 80px;
        }
        .data-grid-style th {
            background-color: #f3f4f6;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .text-input-field {
            text-align: left !important;
        }

        /* ----------------------------------
           モーダル (検索ポップアップ & 確認) の共通スタイル
        ----------------------------------- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* 初期状態では非表示 */
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        .modal-content {
            background-color: #f3f4f6;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }
        
        .confirm-modal .modal-content {
            max-width: 400px;
            max-height: none;
        }

        .modal-body {
            overflow-y: auto;
            padding-top: 10px;
            flex-grow: 1;
        }
        
        .modal-search-result table {
            min-width: 100%; /* モーダル内のテーブル幅を調整 */
        }
        
        .modal-search-result th, .modal-search-result td {
            font-size: 11px;
            padding: 6px;
            min-width: 50px;
        }

        .load-button {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            transition: background-color 0.2s;
        }

        .load-button:hover {
            background-color: #2563eb; /* Blue-600 */
        }

        /* ----------------------------------
           評価シートタブスタイル
        ----------------------------------- */
        .action-tab {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-tab:hover {
            transform: translateY(-1px);
        }

        /* 各ボタンの色定義 */
        .tab-new {
            background-color: #93c5fd; /* Blue-300 */
            color: #1e3a8a; /* Blue-900 */
        }
        .tab-new:hover {
            background-color: #60a5fa; /* Blue-400 */
        }

        .tab-save {
            background-color: #818cf8; /* Indigo-400 */
            color: white;
        }
        .tab-save:hover {
            background-color: #6366f1; /* Indigo-500 */
        }

        .tab-search {
            background-color: #34d399; /* Emerald-400 */
            color: #064e3b; /* Emerald-900 */
        }
        .tab-search:hover {
            background-color: #10b981; /* Emerald-500 */
        }

        .tab-print {
            background-color: #a1a1aa; /* Zinc-400 */
            color: white;
        }
        .tab-print:hover {
            background-color: #71717a; /* Zinc-500 */
        }
        
        /* ----------------------------------
           印刷設定 (A4対応)
        ----------------------------------- */
        @media print {
            @page {
                size: A4;
                margin: 10mm;
            }
            body {
                padding: 0;
                background-color: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            /* 印刷時に不要な要素を非表示 */
            .no-print, #cover-view, #search-view, #database-view, .back-button, header, .modal-overlay {
                display: none !important;
            }
            
            .view-container {
                display: block !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
                min-height: auto !important;
                width: 100% !important;
                max-width: none !important;
                border-radius: 0 !important;
                background-color: white !important;
            }
            
            #input-view {
                display: block;
                /* A4に収めるための縮小調整 */
                zoom: 0.9; 
            }
            
            /* タイトル周りの調整 */
            h2 {
                font-size: 18pt !important;
                margin-bottom: 10px !important;
                border-bottom: 2px solid #000 !important;
            }

            /* テーブルの調整 */
            table {
                margin-top: 5px;
            }
            th, td {
                padding: 2px !important;
                font-size: 10pt !important;
            }
            
            /* 入力欄の背景色を消す */
            input {
                background-color: transparent !important;
            }
        }
    </style>
</head>
<body>

    <!-- ----------------------------------
         ビュー: 表紙
    ----------------------------------- -->
    <div id="cover-view" class="view-container">
        <div class="title-layout">
            <div class="title-icon">
                <i class="fa-solid fa-user-doctor"></i>
            </div>
            <h1 class="main-title">地域支援個別訪問<br>アセスメントシステム</h1>
            
            <div class="nav-simulation">
                <div class="nav-item" onclick="showView('input-view')">評価入力</div>
                <div class="nav-item" onclick="showView('search-view')">氏名検索</div>
                <div class="nav-item" onclick="showView('database-view')">データベース</div>
            </div>
            
            <p id="current-date-display" class="date-subtitle">Date: YYYY.MM.DD</p>
        </div>
    </div>

    <!-- ----------------------------------
         ビュー: 評価入力 (メインフォーム)
    ----------------------------------- -->
    <div id="input-view" class="view-container">
        <div class="flex items-center justify-between mb-6 border-b pb-2 no-print">
            <h2 class="text-3xl font-bold text-gray-800">地域支援個別訪問 アセスメントシート</h2>
            <button onclick="showView('cover-view')" class="back-button text-gray-500 hover:text-indigo-600 transition flex items-center gap-1 font-bold">
                <i class="fa-solid fa-house"></i> 表紙へ
            </button>
        </div>

        <!-- 印刷用ヘッダー（画面では非表示、印刷時のみタイトルの代わりとして機能させる） -->
        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-black pb-1 hidden print:block">地域支援個別訪問 アセスメントシート</h2>

        <!-- 操作メニュー (上部固定) - タブレイアウト -->
        <div class="sticky top-0 bg-[#f3f4f6] py-3 z-10 no-print border-b border-gray-200">
            <div class="flex justify-center space-x-4">
                
                <!-- 1. 新規入力タブ -->
                <button onclick="clearForm(false); alertPlaceholder('フォームをクリアしました。新規に入力してください。', 'blue')" class="action-tab tab-new">
                    <i class="fa-solid fa-file-circle-plus"></i> 新規入力
                </button>

                <!-- 2. 保存タブ (データ保存) -->
                <button onclick="saveData()" class="action-tab tab-save">
                    <i class="fa-solid fa-floppy-disk"></i> 保存
                </button>

                <!-- 3. 検索タブ (データ検索・再出力) -->
                <button onclick="openSearchModal()" class="action-tab tab-search">
                    <i class="fa-solid fa-search"></i> 検索
                </button>

                <!-- 4. 印刷タブ -->
                <button onclick="window.print()" class="action-tab tab-print">
                    <i class="fa-solid fa-print"></i> 印刷
                </button>
            </div>
            <p id="status-message" class="text-center text-sm font-medium h-5 mt-1"></p>
        </div>
        
        <div id="assessment-top" class="assessment-sheet">
            <!-- Header Section -->
            <div class="mb-6 space-y-4">
                <!-- 氏名 (text) -->
                <div class="flex items-end">
                    <span class="w-24 font-bold text-lg">氏名：</span>
                    <!-- tabindex 1 -->
                    <input type="text" id="name" class="flex-1 input-underline text-left px-2 text-lg text-input-field tab-input" placeholder="氏名を入力" tabindex="1" onkeydown="handleEnter(event, 2)">
                </div>
                <!-- 担当理学療法士 (text) -->
                <div class="flex items-end">
                    <span class="w-40 font-bold text-lg">担当理学療法士：</span>
                    <!-- tabindex 2 -->
                    <input type="text" id="ptName" class="flex-1 input-underline text-left px-2 text-lg text-input-field tab-input" placeholder="担当者名を入力" tabindex="2" onkeydown="handleEnter(event, 3)">
                </div>
                <!-- 身長 (number) -->
                <div class="flex items-end">
                    <span class="w-24 font-bold text-lg">身長：</span>
                    <div class="w-48 flex items-end border-b border-black">
                        <!-- tabindex 3 -->
                        <input type="number" step="0.1" id="height" class="text-right px-2 text-lg tab-input" placeholder="0.0" tabindex="3" onkeydown="handleEnter(event, 4)" style="width: 80%">
                        <span class="pb-1">cm</span>
                    </div>
                </div>
            </div>

            <!-- Main Table -->
            <table>
                <thead>
                    <tr>
                        <th colspan="3" rowspan="2" class="w-1/3"></th>
                        <th class="w-1/3">1回目</th>
                        <th class="w-1/3">2回目</th>
                    </tr>
                    <tr>
                        <!-- 1回目 日付 (年/月/日) -->
                        <th class="h-10">
                            <div class="flex items-center justify-center gap-1 text-xs">
                                <span>R</span>
                                <!-- tabindex 4 -->
                                <input type="number" min="0" max="99" id="r1" style="width: 30px;" class="input-underline tab-input" placeholder="00" tabindex="4" onkeydown="handleEnter(event, 5)">
                                <span>年</span>
                                <!-- tabindex 5 -->
                                <input type="number" min="1" max="12" id="month1" style="width: 30px;" class="input-underline tab-input" placeholder="00" tabindex="5" onkeydown="handleEnter(event, 6)">
                                <span>月</span>
                                <!-- tabindex 6 -->
                                <input type="number" min="1" max="31" id="day1" style="width: 30px;" class="input-underline tab-input" placeholder="00" tabindex="6" onkeydown="handleEnter(event, 7)">
                                <span>日</span>
                            </div>
                        </th>
                        <!-- 2回目 日付 (年/月/日) -->
                        <th class="h-10">
                            <div class="flex items-center justify-center gap-1 text-xs">
                                <span>R</span>
                                <!-- tabindex 23 -->
                                <input type="number" min="0" max="99" id="r2" style="width: 30px;" class="input-underline tab-input" placeholder="00" tabindex="23" onkeydown="handleEnter(event, 24)">
                                <span>年</span>
                                <!-- tabindex 24 -->
                                <input type="number" min="1" max="12" id="month2" style="width: 30px;" class="input-underline tab-input" placeholder="00" tabindex="24" onkeydown="handleEnter(event, 25)">
                                <span>月</span>
                                <!-- tabindex 25 -->
                                <input type="number" min="1" max="31" id="day2" style="width: 30px;" class="input-underline tab-input" placeholder="00" tabindex="25" onkeydown="handleEnter(event, 26)">
                                <span>日</span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Weight (number) -->
                    <tr>
                        <td colspan="3" class="cell-label bg-gray-100 font-bold">体重</td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 7 -->
                                <input type="number" step="0.1" id="weight1" class="text-right w-20 tab-input" placeholder="0.0" tabindex="7" onkeydown="handleEnter(event, 8)">
                                <span>kg</span>
                            </div>
                        </td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 26 -->
                                <input type="number" step="0.1" id="weight2" class="text-right w-20 tab-input" placeholder="0.0" tabindex="26" onkeydown="handleEnter(event, 27)">
                                <span>kg</span>
                            </div>
                        </td>
                    </tr>

                    <!-- Grip Strength (number) -->
                    <tr>
                        <td rowspan="2" class="cell-label bg-gray-100 font-bold w-16">握力</td>
                        <td class="cell-label w-12">右</td>
                        <td class="cell-label w-16">1回目</td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 8 -->
                                <input type="number" step="0.1" id="gripR1_1" class="text-right w-20 tab-input" placeholder="0.0" tabindex="8" onkeydown="handleEnter(event, 9)">
                                <span>kg</span>
                            </div>
                        </td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 27 -->
                                <input type="number" step="0.1" id="gripR2_1" class="text-right w-20 tab-input" placeholder="0.0" tabindex="27" onkeydown="handleEnter(event, 28)">
                                <span>kg</span>
                            </div>
                        </td>
                    </tr>
                    <!-- Right 2 -->
                    <tr>
                        <td class="cell-label w-12">右</td>
                        <td class="cell-label">2回目</td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 9 -->
                                <input type="number" step="0.1" id="gripR1_2" class="text-right w-20 tab-input" placeholder="0.0" tabindex="9" onkeydown="handleEnter(event, 10)">
                                <span>kg</span>
                            </div>
                        </td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 28 -->
                                <input type="number" step="0.1" id="gripR2_2" class="text-right w-20 tab-input" placeholder="0.0" tabindex="28" onkeydown="handleEnter(event, 29)">
                                <span>kg</span>
                            </div>
                        </td>
                    </tr>
                    
                    <!-- FRT (number) -->
                    <tr>
                        <td rowspan="2" class="cell-label bg-gray-100 font-bold">FRT</td>
                        <td colspan="2" class="cell-label">1回目</td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 10 -->
                                <input type="number" step="0.1" id="frt1_1" class="text-right w-20 tab-input" placeholder="0.0" tabindex="10" onkeydown="handleEnter(event, 11)">
                                <span>cm</span>
                            </div>
                        </td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 29 -->
                                <input type="number" step="0.1" id="frt2_1" class="text-right w-20 tab-input" placeholder="0.0" tabindex="29" onkeydown="handleEnter(event, 30)">
                                <span>cm</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="cell-label">2回目</td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 11 -->
                                <input type="number" step="0.1" id="frt1_2" class="text-right w-20 tab-input" placeholder="0.0" tabindex="11" onkeydown="handleEnter(event, 12)">
                                <span>cm</span>
                            </div>
                        </td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 30 -->
                                <input type="number" step="0.1" id="frt2_2" class="text-right w-20 tab-input" placeholder="0.0" tabindex="30" onkeydown="handleEnter(event, 31)">
                                <span>cm</span>
                            </div>
                        </td>
                    </tr>

                    <!-- One Leg Standing (number) -->
                    <tr>
                        <td rowspan="2" class="cell-label bg-gray-100 font-bold">片足立ち</td>
                        <td colspan="2" class="cell-label">1回目</td>
                        <td class="p-0">
                            <div class="flex h-10">
                                <div class="flex-1 flex items-center border-r border-black">
                                    <span class="pl-2 pr-1 text-xs">右</span>
                                    <!-- tabindex 12 -->
                                    <input type="number" step="0.1" id="olsR1" class="flex-1 min-w-0 tab-input" placeholder="0.0" tabindex="12" onkeydown="handleEnter(event, 13)">
                                </div>
                                <div class="flex-1 flex items-center">
                                    <span class="pl-2 pr-1 text-xs">左</span>
                                    <!-- tabindex 13 -->
                                    <input type="number" step="0.1" id="olsL1" class="flex-1 min-w-0 tab-input" placeholder="0.0" tabindex="13" onkeydown="handleEnter(event, 14)">
                                </div>
                            </div>
                        </td>
                        <td class="p-0">
                            <div class="flex h-10">
                                <div class="flex-1 flex items-center border-r border-black">
                                    <span class="pl-2 pr-1 text-xs">右</span>
                                    <!-- tabindex 31 -->
                                    <input type="number" step="0.1" id="olsR2" class="flex-1 min-w-0 tab-input" placeholder="0.0" tabindex="31" onkeydown="handleEnter(event, 32)">
                                </div>
                                <div class="flex-1 flex items-center">
                                    <span class="pl-2 pr-1 text-xs">左</span>
                                    <!-- tabindex 32 -->
                                    <input type="number" step="0.1" id="olsL2" class="flex-1 min-w-0 tab-input" placeholder="0.0" tabindex="32" onkeydown="handleEnter(event, 33)">
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="cell-label">2回目</td>
                        <td class="p-0">
                            <div class="flex h-10">
                                <div class="flex-1 flex items-center border-r border-black">
                                    <span class="pl-2 pr-1 text-xs">右</span>
                                    <!-- tabindex 14 -->
                                    <input type="number" step="0.1" id="olsR1_2" class="flex-1 min-w-0 tab-input" placeholder="0.0" tabindex="14" onkeydown="handleEnter(event, 15)">
                                </div>
                                <div class="flex-1 flex items-center">
                                    <span class="pl-2 pr-1 text-xs">左</span>
                                    <!-- tabindex 15 -->
                                    <input type="number" step="0.1" id="olsL1_2" class="flex-1 min-w-0 tab-input" placeholder="0.0" tabindex="15" onkeydown="handleEnter(event, 16)">
                                </div>
                            </div>
                        </td>
                        <td class="p-0">
                            <div class="flex h-10">
                                <div class="flex-1 flex items-center border-r border-black">
                                    <span class="pl-2 pr-1 text-xs">右</span>
                                    <!-- tabindex 33 -->
                                    <input type="number" step="0.1" id="olsR2_2" class="flex-1 min-w-0 tab-input" placeholder="0.0" tabindex="33" onkeydown="handleEnter(event, 34)">
                                </div>
                                <div class="flex-1 flex items-center">
                                    <span class="pl-2 pr-1 text-xs">左</span>
                                    <!-- tabindex 34 -->
                                    <input type="number" step="0.1" id="olsL2_2" class="flex-1 min-w-0 tab-input" placeholder="0.0" tabindex="34" onkeydown="handleEnter(event, 35)">
                                </div>
                            </div>
                        </td>
                    </tr>

                    <!-- SS-5 (number) -->
                    <tr>
                        <td colspan="3" class="cell-label bg-gray-100 font-bold h-12">SS-5</td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 16 -->
                                <input type="number" min="0" id="ss5_1" class="text-right w-20 tab-input" placeholder="0" tabindex="16" onkeydown="handleEnter(event, 17)">
                                <span>回</span>
                            </div>
                        </td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 35 -->
                                <input type="number" min="0" id="ss5_2" class="text-right w-20 tab-input" placeholder="0" tabindex="35" onkeydown="handleEnter(event, 36)">
                                <span>回</span>
                            </div>
                        </td>
                    </tr>
                    <!-- 椅子の高さ (number) -->
                    <tr>
                        <td colspan="3" class="cell-label h-10">椅子の高さ</td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 17 -->
                                <input type="number" step="0.1" id="chairHeight1" class="text-right w-20 tab-input" placeholder="0.0" tabindex="17" onkeydown="handleEnter(event, 18)">
                                <span>cm</span>
                            </div>
                        </td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 36 -->
                                <input type="number" step="0.1" id="chairHeight2" class="text-right w-20 tab-input" placeholder="0.0" tabindex="36" onkeydown="handleEnter(event, 37)">
                                <span>cm</span>
                            </div>
                        </td>
                    </tr>
                    
                    <!-- 上腕周径 (number) -->
                    <tr>
                        <td colspan="3" class="cell-label bg-gray-100 font-bold h-12">上腕周径</td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 18 -->
                                <input type="number" step="0.1" id="armCirc1" class="text-right w-20 tab-input" placeholder="0.0" tabindex="18" onkeydown="handleEnter(event, 19)">
                                <span>cm</span>
                            </div>
                        </td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 37 -->
                                <input type="number" step="0.1" id="armCirc2" class="text-right w-20 tab-input" placeholder="0.0" tabindex="37" onkeydown="handleEnter(event, 38)">
                                <span>cm</span>
                            </div>
                        </td>
                    </tr>
                    <!-- 大腿周径 (number) -->
                    <tr>
                        <td colspan="3" class="cell-label bg-gray-100 font-bold h-12">大腿周径</td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 19 -->
                                <input type="number" step="0.1" id="thighCirc1" class="text-right w-20 tab-input" placeholder="0.0" tabindex="19" onkeydown="handleEnter(event, 20)">
                                <span>cm</span>
                            </div>
                        </td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 38 -->
                                <input type="number" step="0.1" id="thighCirc2" class="text-right w-20 tab-input" placeholder="0.0" tabindex="38" onkeydown="handleEnter(event, 39)">
                                <span>cm</span>
                            </div>
                        </td>
                    </tr>
                    <!-- 下腿周径 (number) -->
                    <tr>
                        <td colspan="3" class="cell-label bg-gray-100 font-bold h-12">下腿周径</td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 20 -->
                                <input type="number" step="0.1" id="calfCirc1" class="text-right w-20 tab-input" placeholder="0.0" tabindex="20" onkeydown="handleEnter(event, 21)">
                                <span>cm</span>
                            </div>
                        </td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 39 -->
                                <input type="number" step="0.1" id="calfCirc2" class="text-right w-20 tab-input" placeholder="0.0" tabindex="39" onkeydown="handleEnter(event, 40)">
                                <span>cm</span>
                            </div>
                        </td>
                    </tr>

                    <!-- RSST (number) -->
                    <tr>
                        <td colspan="3" class="cell-label bg-gray-100 font-bold h-12">RSST</td>
                        <td class="relative">
                            <div class="flex items-center justify-center h-full">
                                <!-- tabindex 21 -->
                               <input type="number" min="0" id="rsst1" class="w-16 text-center input-underline mr-2 tab-input" placeholder="0" tabindex="21" onkeydown="handleEnter(event, 22)">
                               <span>回 ／ 30秒</span>
                           </div>
                       </td>
                       <td class="relative">
                            <div class="flex items-center justify-center h-full">
                                <!-- tabindex 40 -->
                               <input type="number" min="0" id="rsst2" class="w-16 text-center input-underline mr-2 tab-input" placeholder="0" tabindex="40" onkeydown="handleEnter(event, 41)">
                               <span>回 ／ 30秒</span>
                           </div>
                       </td>
                    </tr>

                    <!-- 歩数 (number) -->
                    <tr>
                        <td colspan="3" class="cell-label bg-gray-100 font-bold h-12">歩数</td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 22 -->
                                <input type="number" min="0" id="steps1" class="text-right w-20 tab-input" placeholder="0" tabindex="22" onkeydown="handleEnter(event, 23)">
                                <span>歩</span>
                            </div>
                        </td>
                        <td>
                            <div class="input-group justify-end pr-4">
                                <!-- tabindex 41 -->
                                <input type="number" min="0" id="steps2" class="text-right w-20 tab-input" placeholder="0" tabindex="41" onkeydown="handleEnter(event, 42)">
                                <span>歩</span>
                            </div>
                        </td>
                    </tr>

                    <!-- MNA (number) -->
                    <tr>
                        <td colspan="3" class="cell-label bg-gray-100 font-bold h-12">低栄養リスク（MNA）</td>
                        <td>
                            <div class="input-group justify-end pr-12">
                                <!-- tabindex 42 -->
                                <input type="number" min="0" id="mna1" class="text-right w-20 input-underline tab-input" placeholder="0" tabindex="42" onkeydown="handleEnter(event, 43)">
                                <span>点</span>
                            </div>
                        </td>
                        <td>
                            <div class="input-group justify-end pr-12">
                                <!-- tabindex 43 -->
                                <input type="number" min="0" id="mna2" class="text-right w-20 input-underline tab-input" placeholder="0" tabindex="43" onkeydown="handleEnter(event, 44)">
                                <span>点</span>
                            </div>
                        </td>
                    </tr>

                    <!-- Pain (部位: text, NRS: number) -->
                    <tr>
                        <td colspan="3" rowspan="2" class="cell-label bg-gray-100 font-bold">膝の痛み</td>
                        <td class="h-12 text-left px-2">
                            <div class="flex items-center">
                                <span class="mr-2">部位：</span>
                                <!-- tabindex 44 -->
                                <input type="text" id="painArea1" class="flex-1 text-left tab-input" placeholder="部位を入力" tabindex="44" onkeydown="handleEnter(event, 45)">
                            </div>
                        </td>
                        <td class="h-12 text-left px-2">
                            <div class="flex items-center">
                                <span class="mr-2">部位：</span>
                                <!-- tabindex 46 -->
                                <input type="text" id="painArea2" class="flex-1 text-left tab-input" placeholder="部位を入力" tabindex="46" onkeydown="handleEnter(event, 47)">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="h-12">
                            <div class="flex items-center justify-center">
                                <span class="mr-2">NRS：</span>
                                <!-- tabindex 45 -->
                                <input type="number" min="0" max="10" id="painNrs1" class="w-12 text-center input-underline tab-input" placeholder="0" tabindex="45" onkeydown="handleEnter(event, 46)">
                                <span class="ml-2">点</span>
                            </div>
                        </td>
                        <td class="h-12">
                            <div class="flex items-center justify-center">
                                <span class="mr-2">NRS：</span>
                                <!-- tabindex 47 -->
                                <input type="number" min="0" max="10" id="painNrs2" class="w-12 text-center input-underline tab-input" placeholder="0" tabindex="47" onkeydown="handleEnter(event, 0)"> <!-- 最後の項目は0にして何もしない -->
                                <span class="ml-2">点</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <!-- ----------------------------------
         ビュー: 氏名検索
    ----------------------------------- -->
    <div id="search-view" class="view-container">
        <div class="flex items-center justify-between mb-6 border-b pb-2 px-8 pt-8">
            <h2 class="text-3xl font-bold text-gray-800">氏名検索</h2>
            <button onclick="showView('cover-view')" class="back-button text-gray-500 hover:text-indigo-600 transition flex items-center gap-1 font-bold">
                <i class="fa-solid fa-house"></i> 表紙へ
            </button>
        </div>
        <div class="p-8">
            <div class="flex items-center mb-6">
                <input type="text" id="search-input" class="w-64 p-3 border rounded-l-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="氏名を入力..." onkeypress="if(event.key === 'Enter') searchData()">
                <button onclick="searchData()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-r-lg shadow-md transition duration-200">
                    <i class="fa-solid fa-magnifying-glass"></i> 検索
                </button>
            </div>
            
            <div id="search-results-container">
                <!-- 検索結果テーブルがここに表示されます -->
                <p class="text-gray-500">検索条件を入力して「検索」ボタンを押してください。</p>
            </div>
        </div>
    </div>

    <!-- ----------------------------------
         ビュー: データベース
    ----------------------------------- -->
    <div id="database-view" class="view-container">
        <div class="px-8 pt-8">
            <div class="flex items-center justify-between mb-6 border-b pb-2">
                <h2 class="text-3xl font-bold text-gray-800">保存済み評価データ一覧</h2>
                <button onclick="showView('cover-view')" class="back-button text-gray-500 hover:text-indigo-600 transition flex items-center gap-1 font-bold">
                    <i class="fa-solid fa-house"></i> 表紙へ
                </button>
            </div>
            
            <div class="flex justify-end mb-4 gap-4 no-print">
                <!-- 修正: 項目名を「データ読み込み (CSV)」に変更 -->
                <button onclick="document.getElementById('csv-import-file').click()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm hover:bg-blue-200 transition flex items-center gap-2">
                    <i class="fa-solid fa-file-import"></i> データ読み込み (CSV)
                </button>
                <input type="file" id="csv-import-file" accept=".csv" style="display: none;" onchange="importFromCSV(event)">

                <button onclick="exportToCSV()" class="bg-green-100 text-green-700 px-4 py-2 rounded-lg text-sm hover:bg-green-200 transition flex items-center gap-2">
                    <i class="fa-solid fa-file-csv"></i> CSV出力
                </button>
                <!-- 修正: clearAllData() を openConfirmModal() でラップ -->
                <button onclick="openConfirmModal('全ての評価データを完全に削除してもよろしいですか？この操作は元に戻せません。', clearAllData)" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg text-sm hover:bg-red-200 transition flex items-center gap-2">
                    <i class="fa-solid fa-trash-can"></i> 全データ削除
                </button>
            </div>
            
            <div id="data-grid" class="data-grid-container-style rounded-lg shadow-md mb-8">
                <div class="data-grid-style">
                    <!-- データテーブルがここに挿入されます -->
                    <p id="data-empty-message" class="p-4 text-gray-500 text-center">保存されたデータはありません。</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ----------------------------------
         モーダル: 評価データ検索
    ----------------------------------- -->
    <div id="search-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">過去の評価データ検索</h3>
                <button onclick="closeSearchModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fa-solid fa-times text-2xl"></i>
                </button>
            </div>

            <div class="flex items-center mb-4">
                <input type="text" id="modal-search-input" class="w-64 p-2 border rounded-l-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="氏名を入力..." onkeypress="if(event.key === 'Enter') searchModalData()">
                <button onclick="searchModalData()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-r-lg shadow-md transition duration-200 text-sm">
                    <i class="fa-solid fa-magnifying-glass"></i> 検索
                </button>
            </div>

            <div id="modal-search-results" class="modal-body">
                <!-- 検索結果はここに挿入されます -->
                <p class="text-gray-500">氏名を入力して「検索」ボタンを押してください。</p>
            </div>
        </div>
    </div>

    <!-- ----------------------------------
         モーダル: 確認 (Confirm) ダイアログ
    ----------------------------------- -->
    <div id="confirm-modal" class="modal-overlay confirm-modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-800 mb-4" id="confirm-message"></h3>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">
                    いいえ
                </button>
                <button id="confirm-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    はい (削除)
                </button>
            </div>
        </div>
    </div>

    <!-- ----------------------------------
         JavaScript (既存のロジック + Enterキー移動)
    ----------------------------------- -->
    <script>
        // データ保存用のキー
        const STORAGE_KEY = 'assessmentData';

        // -----------------------------------------------------
        // 1. ビュー切り替えロジック
        // -----------------------------------------------------
        let currentView = 'cover-view';

        function showView(viewId) {
            // ここで全てのカスタムモーダルを閉じます。
            // これにより、モーダルがDOMのクリックイベントをブロックするのを防ぎます。
            closeSearchModal();
            closeConfirmModal(); // 確認モーダルも閉じる

            // 現在のビューを非表示にする
            const current = document.getElementById(currentView);
            if (current) {
                current.style.display = 'none';
            }

            // 新しいビューを表示する
            const next = document.getElementById(viewId);
            if (next) {
                // 表紙だけflex表示、他はblock表示
                if (viewId === 'cover-view') {
                    next.style.display = 'flex';
                } else {
                    next.style.display = 'block';
                }
                currentView = viewId;
            }
            
            // データベースビューに切り替えた際、データを再読み込み (常に最新のデータを取得する)
            if (viewId === 'database-view') {
                loadDataGrid();
            }
            // 氏名検索ビューに切り替えた際、入力欄をクリア
            if (viewId === 'search-view') {
                const searchInput = document.getElementById('search-input');
                if (searchInput) searchInput.value = '';
                document.getElementById('search-results-container').innerHTML = '<p class="text-gray-500">検索条件を入力して「検索」ボタンを押してください。</p>';
            }
        }

        // -----------------------------------------------------
        // 2. Enterキーでの次の入力欄への移動ロジック (最終修正)
        // -----------------------------------------------------

        /**
         * Enterキーが押されたとき、次のtabindexを持つ要素にフォーカスを移動する。
         * @param {Event} event - キーボードイベント
         * @param {number} nextTabIndex - 次にフォーカスを移動させたい要素のtabindex
         */
        function handleEnter(event, nextTabIndex) {
            // Enterキー以外の場合は何もしない
            if (event.key !== 'Enter') {
                return;
            }

            // デフォルトのEnter動作（フォーム送信など）を防止
            event.preventDefault();

            const activeElement = document.activeElement;

            // ★ 修正点: 現在の入力フィールドがアクティブであれば、changeとblurで値を確定させる
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                // changeイベントを意図的に発火させて、ブラウザに値が変更されたことを伝える
                activeElement.dispatchEvent(new Event('change', { bubbles: true }));
                // フォーカスを外すことで、IME入力中の値を強制的に確定させる
                activeElement.blur();
            }

            if (nextTabIndex === 0) {
                // 最後の項目に到達したら、次の項目への移動は行わない
                return;
            }

            // ★ 最終修正: blur()が完了するのを待つために、わずかな遅延を設ける
            setTimeout(() => {
                const nextElement = document.querySelector(`[tabindex="${nextTabIndex}"]`);
                
                if (nextElement) {
                    // 見つかった要素にフォーカスを移動
                    nextElement.focus();
                    
                    // もしテキストや数値入力欄であれば、内容を全選択して上書きしやすくする
                    if (nextElement.tagName === 'INPUT' && (nextElement.type === 'text' || nextElement.type === 'number')) {
                        nextElement.select();
                    }
                }
            }, 50); // 50ミリ秒の遅延
        }
        
        // -----------------------------------------------------
        // 3. データ収集・保存 (localStorage)
        // -----------------------------------------------------

        // フォームからデータを収集し、Excel列構造に合わせる
        function collectFormData() {
            const getValue = (id) => {
                const element = document.getElementById(id);
                if (!element) return '';
                
                if (element.type === 'number') {
                    // 数値入力欄が空の場合は空文字列（''）を返す
                    if (element.value === '') {
                        return '';
                    }
                    
                    // 値があれば数値として返す（日付関連も含む）
                    return parseFloat(element.value);

                } else {
                    // テキストを返す
                    return element.value || '';
                }
            };
            
            const now = new Date();

            // Excel列順に合わせた構造
            return {
                timestamp: now.toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }),
                name: getValue('name'),
                ptName: getValue('ptName'),
                height: getValue('height'),

                // 1回目データ
                r1: getValue('r1'),
                month1: getValue('month1'),
                day1: getValue('day1'),
                weight1: getValue('weight1'),
                gripR1_1: getValue('gripR1_1'),
                gripR1_2: getValue('gripR1_2'),
                frt1_1: getValue('frt1_1'),
                frt1_2: getValue('frt1_2'),
                olsR1: getValue('olsR1'), // 1回目測定1 (olsR1)
                olsL1: getValue('olsL1'), // 1回目測定1 (olsL1)
                olsR1_2: getValue('olsR1_2'), // 1回目測定2 (olsR1_2)
                olsL1_2: getValue('olsL1_2'), // 1回目測定2 (olsL1_2)
                rsst1: getValue('rsst1'),
                ss5_1: getValue('ss5_1'),
                chairHeight1: getValue('chairHeight1'),
                armCirc1: getValue('armCirc1'),
                thighCirc1: getValue('thighCirc1'),
                calfCirc1: getValue('calfCirc1'),
                steps1: getValue('steps1'),
                mna1: getValue('mna1'),
                painArea1: getValue('painArea1'),
                painNrs1: getValue('painNrs1'),

                // 2回目データ
                r2: getValue('r2'),
                month2: getValue('month2'),
                day2: getValue('day2'),
                weight2: getValue('weight2'),
                gripR2_1: getValue('gripR2_1'),
                gripR2_2: getValue('gripR2_2'),
                frt2_1: getValue('frt2_1'),
                frt2_2: getValue('frt2_2'),
                olsR2: getValue('olsR2'), // 2回目測定1 (olsR2)
                olsL2: getValue('olsL2'), // 2回目測定1 (olsL2)
                olsR2_2: getValue('olsR2_2'), // 2回目測定2 (olsR2_2)
                olsL2_2: getValue('olsL2_2'), // 2回目測定2 (olsL2_2)
                rsst2: getValue('rsst2'),
                ss5_2: getValue('ss5_2'),
                chairHeight2: getValue('chairHeight2'),
                armCirc2: getValue('armCirc2'),
                thighCirc2: getValue('thighCirc2'),
                calfCirc2: getValue('calfCirc2'),
                steps2: getValue('steps2'),
                mna2: getValue('mna2'),
                painArea2: getValue('painArea2'),
                painNrs2: getValue('painNrs2'),
            };
        }

        // データをlocalStorageに保存
        function saveData() {
            const data = collectFormData();
            const status = document.getElementById('status-message');
            
            if (data.name === '') {
                status.textContent = 'エラー: 氏名は必須入力です。';
                status.classList.add('text-red-600');
                status.classList.remove('text-green-600', 'text-blue-600');
                setTimeout(() => status.textContent = '', 3000);
                return;
            }

            try {
                let existingData = loadAllData();
                // ユニークIDを付与（編集・削除のため）
                data.id = Date.now().toString(); 
                existingData.unshift(data); // 最新のデータを先頭に追加
                localStorage.setItem(STORAGE_KEY, JSON.stringify(existingData));
                
                alertPlaceholder('データを保存しました！', 'green'); // alertPlaceholderで通知
                
                // フォームの自動クリアを停止
                // clearForm(true); 
                
            } catch (error) {
                console.error("Data save error:", error);
                alertPlaceholder('保存中にエラーが発生しました。', 'red');
            }
            // ステータス表示はalertPlaceholderに任せるため、ここでは非表示にリセット
            status.textContent = '';
            status.classList.remove('text-red-600', 'text-green-600', 'text-blue-600');
        }
        
        // フォーム入力項目をクリア
        function clearForm(keepHeader = false) {
            const formInputs = document.querySelectorAll('#input-view input');
            formInputs.forEach(input => {
                const id = input.id;
                
                // keepHeaderがtrueの場合、nameとptNameはクリアしない
                if (keepHeader && (id === 'name' || id === 'ptName')) {
                    return; 
                }
                
                // ラジオボタンやチェックボックスがないため、全て値をクリア
                input.value = '';
            });
            
            // ステータスメッセージをリセット
            const status = document.getElementById('status-message');
            if(status) {
                status.textContent = '';
                status.className = 'text-center text-sm font-medium h-5 mt-1';
            }
        }
        
        // フォームにデータをロードする関数
        function loadFormData(data) {
            // まずフォームをリセット（ヘッダー部分を含む全て）
            clearForm(false);
            const status = document.getElementById('status-message');

            try {
                // 各フィールドに値を設定
                for (const key in data) {
                    const element = document.getElementById(key);
                    if (element) {
                        // データが空文字列の場合はそのまま空欄にする
                        element.value = data[key] === '' ? '' : data[key];
                    }
                }
                
                alertPlaceholder(`氏名: ${data.name} のデータをロードしました。`, 'blue');

            } catch (error) {
                console.error("Data load error:", error);
                alertPlaceholder('データのロード中にエラーが発生しました。', 'red');
            }

            // ロード後、モーダルを閉じる
            closeSearchModal();
            
            // ステータス表示はalertPlaceholderに任せるため、ここでは非表示にリセット
            status.textContent = '';
            status.classList.remove('text-red-600', 'text-green-600', 'text-blue-600');
        }

        // -----------------------------------------------------
        // 4. データ一覧表示 (データベース) & 検索
        // -----------------------------------------------------

        const COLUMN_LABELS = {
            timestamp: '保存日時',
            name: '氏名',
            ptName: '担当理学療法士',
            height: '身長 (cm)',
            
            // 1回目
            r1: 'R年1', month1: '月1', day1: '日1', 
            weight1: '体重1(kg)', 
            gripR1_1: '握力右1-1(kg)', gripR1_2: '握力右1-2(kg)',
            frt1_1: 'FRT1-1(cm)', frt1_2: 'FRT1-2(cm)', 
            olsR1: '片足立右1-1(秒)', olsL1: '片足立左1-1(秒)',
            olsR1_2: '片足立右1-2(秒)', olsL1_2: '片足立左1-2(秒)',
            rsst1: 'RSST1(回)',
            ss5_1: 'SS-5 1(回)', chairHeight1: '椅子高1(cm)', 
            armCirc1: '上腕周1(cm)',
            thighCirc1: '大腿周1(cm)', calfCirc1: '下腿周1(cm)', 
            steps1: '歩数1(歩)',
            mna1: 'MNA1(点)', painArea1: '膝痛部位1', painNrs1: '膝痛NRS1',

            // 2回目
            r2: 'R年2', month2: '月2', day2: '日2',
            weight2: '体重2(kg)', 
            gripR2_1: '握力右2-1(kg)', gripR2_2: '握力右2-2(kg)',
            frt2_1: 'FRT2-1(cm)', frt2_2: 'FRT2-2(cm)', 
            olsR2: '片足立右2-1(秒)', olsL2: '片足立左2-1(秒)',
            olsR2_2: '片足立右2-2(秒)', olsL2_2: '片足立左2-2(秒)',
            rsst2: 'RSST2(回)',
            ss5_2: 'SS-5 2(回)', chairHeight2: '椅子高2(cm)', 
            armCirc2: '上腕周2(cm)',
            thighCirc2: '大腿周2(cm)', calfCirc2: '下腿周2(cm)', 
            steps2: '歩数2(歩)',
            mna2: 'MNA2(点)', painArea2: '膝痛部位2', painNrs2: '膝痛NRS2'
        };

        const COLUMN_ORDER = [
            'timestamp', 'name', 'ptName', 'height',
            // 1回目データ
            'r1', 'month1', 'day1', 'weight1', 
            'gripR1_1', 'gripR1_2', 
            'frt1_1', 'frt1_2', 
            'olsR1', 'olsL1', 'olsR1_2', 'olsL1_2', 
            'rsst1', 'ss5_1', 'chairHeight1', 'armCirc1', 'thighCirc1', 'calfCirc1', 
            'steps1', 'mna1', 'painArea1', 'painNrs1',
            // 2回目データ
            'r2', 'month2', 'day2', 'weight2', 
            'gripR2_1', 'gripR2_2', 
            'frt2_1', 'frt2_2', 
            'olsR2', 'olsL2', 'olsR2_2', 'olsL2_2', 
            'rsst2', 'ss5_2', 'chairHeight2', 'armCirc2', 'thighCirc2', 'calfCirc2', 
            'steps2', 'mna2', 'painArea2', 'painNrs2'
        ];
        
        // ローカルストレージから全データを取得
        function loadAllData() {
             let data = [];
            try {
                data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            } catch (e) {
                console.error("Error parsing localStorage data:", e);
                data = [];
            }
            return data;
        }

        /**
         * データベースビューのテーブルHTMLを生成する共通関数
         * @param {Array<Object>} data - 表示するデータ配列
         * @param {boolean} isSearchResult - 検索結果かどうか (操作列の削除処理を調整)
         * @param {boolean} forModal - モーダル内で使用するかどうか (操作列をロードボタンに変更)
         * @returns {HTMLTableElement} - 生成されたテーブル要素
         */
        function generateTableHTML(data, isSearchResult = false, forModal = false) {
             const table = document.createElement('table');
            table.classList.add('w-full', 'table-fixed');

            // ヘッダー行の生成
            let headerHTML = '<thead><tr>';
            const displayKeys = forModal ? ['timestamp', 'name', 'ptName'] : COLUMN_ORDER; // モーダルでは項目を絞る
            displayKeys.forEach(key => {
                headerHTML += `<th class="bg-gray-200">${COLUMN_LABELS[key] || key}</th>`;
            });
            headerHTML += `<th class="w-20 bg-gray-200">操作</th>`; // 操作列
            headerHTML += '</tr></thead>';
            table.innerHTML += headerHTML;

            // データ行の生成
            let bodyHTML = '<tbody>';
            data.forEach((item, index) => {
                bodyHTML += `<tr>`;
                displayKeys.forEach(key => {
                    let value = item[key];
                    
                    // 値が空文字列の場合は表示も空欄（&nbsp;）にする
                    if (value === '') {
                        value = ''; // 表示は空欄
                    }
                    // 数値の表示を調整（空欄でなければ）
                    else if (typeof value === 'number' && key !== 'mna1' && key !== 'mna2' && key !== 'painNrs1' && key !== 'painNrs2' && key !== 'ss5_1' && key !== 'ss5_2' && key !== 'rsst1' && key !== 'rsst2' && key !== 'steps1' && key !== 'steps2' && key !== 'r1' && key !== 'r2' && key !== 'month1' && key !== 'month2' && key !== 'day1' && key !== 'day2') {
                        // 小数点以下の数値（例：体重、握力、FRTなど）は小数点第一位まで表示
                        value = value % 1 !== 0 ? value.toFixed(1) : value;
                    }
                    
                    bodyHTML += `<td>${value}</td>`;
                });
                
                // 操作列の生成
                if (forModal) {
                    // モーダル用: ロードボタン
                    bodyHTML += `<td><button onclick="loadDataById('${item.id}')" class="load-button">ロード</button></td>`;
                } else {
                    // データベースビュー用: 削除ボタン 
                    const deleteAction = isSearchResult ? 
                        `deleteData('${item.id}', true)` : 
                        `deleteData('${item.id}')`;
                    
                    // 削除操作の前に確認モーダルを表示するラッパー
                    const confirmWrapper = `openConfirmModal('このデータを本当に削除しますか？', () => { ${deleteAction} })`;
                    
                    bodyHTML += `<td><button onclick="${confirmWrapper}" class="text-red-500 hover:text-red-700 font-medium text-sm">削除</button></td>`;
                }
                bodyHTML += `</tr>`;
            });
            bodyHTML += '</tbody>';
            table.innerHTML += bodyHTML;
            
            return table;
        }

        // データベース（localStorage）からデータを読み込み、グリッドを生成
        function loadDataGrid() {
            const gridContainer = document.getElementById('data-grid');
            // data-grid-styleの子要素としてテーブルを配置しているため、その子要素を操作
            const dataGridStyleDiv = gridContainer.querySelector('.data-grid-style');
            const emptyMessage = document.getElementById('data-empty-message');
            
            if (!gridContainer || !emptyMessage || !dataGridStyleDiv) return;

            // 既存のテーブルを削除 (空メッセージ要素は残す)
            let currentTable = dataGridStyleDiv.querySelector('table');
            if (currentTable) {
                currentTable.remove();
            }

            let data = loadAllData();
            
            if (data.length === 0) {
                emptyMessage.style.display = 'block';
                return;
            }
            // データがある場合はメッセージを非表示に
            emptyMessage.style.display = 'none';
            
            // タイムスタンプで降順にソートして最新のものを上に
            data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const table = generateTableHTML(data);
            dataGridStyleDiv.appendChild(table);
        }
        
        // 氏名検索画面 (search-view) の検索機能
        function searchData() {
            const query = document.getElementById('search-input').value.trim();
            const resultsContainer = document.getElementById('search-results-container');
            
            if (!query) {
                // アラートの代わりにインラインメッセージを使用
                resultsContainer.innerHTML = '<p class="text-red-500 mt-4">検索キーワードを入力してください。</p>';
                return;
            }
            
            let data = loadAllData();
            
            // 氏名(name)にキーワードが含まれるものをフィルタリング
            const results = data.filter(item => item.name && item.name.includes(query));
            
            resultsContainer.innerHTML = ''; // 結果をクリア
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-500 mt-4">該当するデータが見つかりませんでした。</p>';
                return;
            }
            
            const resultWrapper = document.createElement('div');
            resultWrapper.classList.add('data-grid-style', 'rounded-lg', 'shadow-md', 'mt-4');
            
            // タイムスタンプで降順にソートして最新のものを上に
            results.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const table = generateTableHTML(results, true);
            resultWrapper.appendChild(table);
            
             // 件数を表示
            const countInfo = document.createElement('p');
            countInfo.classList.add('text-indigo-600', 'font-bold', 'mb-2');
            countInfo.textContent = `${results.length} 件のデータが見つかりました。`;
            resultsContainer.appendChild(countInfo);
            resultsContainer.appendChild(resultWrapper);
        }
        
        // 特定のデータを削除 (修正: confirm()を削除)
        function deleteData(id, isSearchResult = false) {
            try {
                let existingData = loadAllData();
                const updatedData = existingData.filter(item => item.id !== id);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(updatedData));
                
                if (isSearchResult) {
                    searchData(); // 氏名検索結果を更新
                } 
                // どちらの場合もデータベースビューを更新
                if (currentView === 'database-view') {
                     loadDataGrid();
                }

                alertPlaceholder('データを削除しました。', 'red');

            } catch (e) {
                console.error("Data deletion error:", e);
                alertPlaceholder("データの削除中にエラーが発生しました。", 'red');
            }
        }
        
        // 全データを削除 (修正: confirm()を削除)
        function clearAllData() {
            try {
                localStorage.removeItem(STORAGE_KEY);
                loadDataGrid();
                alertPlaceholder("全てのデータが削除されました。", 'red');
            } catch (e) {
                console.error("Clear all data error:", e);
                alertPlaceholder("全データ削除中にエラーが発生しました。", 'red');
            }
        }

        // CSV出力
        function exportToCSV() {
            const rawData = localStorage.getItem(STORAGE_KEY);
            if (!rawData) {
                console.log("保存されたデータがありません。");
                alertPlaceholder('データがありません', 'red');
                return;
            }
            const data = loadAllData();
            if (data.length === 0) {
                console.log("保存されたデータがありません。");
                alertPlaceholder('データがありません', 'red');
                return;
            }

            // ヘッダー行の作成
            const headers = COLUMN_ORDER.map(key => COLUMN_LABELS[key] || key);
            const csvRows = [];
            csvRows.push(headers.join(','));

            // データ行の作成
            data.forEach(row => {
                const values = COLUMN_ORDER.map(key => {
                    // 空文字列はそのまま出力
                    const val = row[key] === undefined || row[key] === null || row[key] === '' ? '' : row[key];
                    // ダブルクォーテーションのエスケープと値の囲い込み
                    const stringVal = String(val);
                    return `"${stringVal.replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            });

            // BOM付きCSVファイルの作成とダウンロード
            const csvString = csvRows.join('\r\n');
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); // Excelでの文字化け防止
            const blob = new Blob([bom, csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `assessment_data_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alertPlaceholder('CSVファイルを生成しダウンロードしました', 'green');
        }

        // CSVインポート（データ復元）
        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 修正: window.confirm の代わりにカスタムモーダルを使用
            openConfirmModal('CSVファイルをインポートすると、現在のデータに追加されます。続行しますか？', () => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        
                        // BOM除去 (あれば)
                        let csvText = text.startsWith('\ufeff') ? text.substring(1) : text; 

                        const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
                        if (lines.length < 2) {
                            alertPlaceholder("有効なデータ行がありません。", 'red');
                            return;
                        }

                        // ヘッダー行は1行目、データは2行目から
                        const headerRow = lines[0]; 
                        const dataRows = lines.slice(1); 
                        
                        // ヘッダーを解析 (ダブルクォーテーションを除去)
                        // 正規表現で、ダブルクォーテーションで囲まれた内部のカンマは無視
                        const headerDelimiter = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
                        const headers = headerRow.split(headerDelimiter).map(h => h.replace(/^"|"$/g, '').trim());

                        let importedData = loadAllData();
                        let importCount = 0;
                        
                        // 内部キーとCSVヘッダーのインデックスを対応付ける
                        const headerMap = {};
                        headers.forEach((h, index) => {
                            // COLUMN_LABELSから逆引きする (例: '氏名' -> 'name')
                            for(const key in COLUMN_LABELS) {
                                if (COLUMN_LABELS[key] === h) {
                                    headerMap[key] = index;
                                    return;
                                }
                            }
                        });

                        // データ行の処理
                        dataRows.forEach((line, i) => {
                            const values = line.split(headerDelimiter).map(v => v.replace(/^"|"$/g, '').trim());
                            
                            // 必要なフィールドが欠けている場合はスキップ
                            if (!values.length || values.length < headers.length) return;

                            const newData = {};
                            let isValidRow = false; // 氏名が含まれているかチェック用

                            COLUMN_ORDER.forEach(key => {
                                const colIndex = headerMap[key];
                                let value = '';

                                if (colIndex !== undefined) {
                                    value = values[colIndex];
                                    
                                    // 数値型に変換
                                    if (!isNaN(parseFloat(value)) && isFinite(value) && value !== '') {
                                        value = parseFloat(value);
                                    }
                                    
                                    if (key === 'name' && value && value !== '') {
                                        isValidRow = true;
                                    }

                                    newData[key] = value;
                                } else {
                                    newData[key] = '';
                                }
                            });

                            if (isValidRow) {
                                // IDが重複しないように日付と行番号を組み合わせる
                                newData.id = Date.now().toString() + '-' + i + '-' + Math.random().toString(36).substring(2, 6);
                                importedData.unshift(newData);
                                importCount++;
                            }
                        });

                        localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData));
                        loadDataGrid();
                        alertPlaceholder(`${importCount}件のデータを復元しました。`, 'green');

                    } catch (error) {
                        console.error("CSV Import Error:", error);
                        alertPlaceholder("CSVファイルの読み込み中にエラーが発生しました。ファイル形式を確認してください。", 'red');
                    }
                };
                reader.readAsText(file, 'utf-8');
            });
            
            // ファイル選択をリセット
            event.target.value = null; 
        }
        
        // alert()の代替として一時的なメッセージを表示する関数
        function alertPlaceholder(message, type = 'blue', duration = 3000) {
            let alertBox = document.getElementById('temp-alert-box');
            
            if (!alertBox) {
                alertBox = document.createElement('div');
                alertBox.id = 'temp-alert-box';
                alertBox.classList.add('fixed', 'top-4', 'right-4', 'p-3', 'rounded-lg', 'font-bold', 'shadow-xl', 'z-50', 'transition-opacity', 'duration-300');
                document.body.appendChild(alertBox); // body直下に追加
            }
            
            alertBox.className = ''; // クラスをリセット
            alertBox.classList.add('fixed', 'top-4', 'right-4', 'p-3', 'rounded-lg', 'font-bold', 'shadow-xl', 'z-50', 'transition-opacity', 'duration-300');
            
            if (type === 'green') {
                alertBox.classList.add('bg-green-500', 'text-white');
            } else if (type === 'red') {
                alertBox.classList.add('bg-red-500', 'text-white');
            } else if (type === 'blue') {
                alertBox.classList.add('bg-blue-500', 'text-white');
            } else {
                alertBox.classList.add('bg-gray-700', 'text-white');
            }
            
            alertBox.textContent = message;
            alertBox.style.opacity = 1;
            
            setTimeout(() => {
                alertBox.style.opacity = 0;
            }, duration);
        }

        // -----------------------------------------------------
        // 5. カスタム確認モーダルロジック
        // -----------------------------------------------------

        /**
         * カスタム確認モーダルを表示し、ユーザーのアクション後にコールバックを実行します。
         * @param {string} message - モーダルに表示するメッセージ。
         * @param {function} onConfirm - 「はい」が押されたときに実行するコールバック関数。
         * @param {function} [onCancel] - 「いいえ」が押されたときに実行するコールバック関数（オプション）。
         */
        function openConfirmModal(message, onConfirm, onCancel = () => {}) {
            const modal = document.getElementById('confirm-modal');
            const messageElement = document.getElementById('confirm-message');
            const okButton = document.getElementById('confirm-ok');
            const cancelButton = document.getElementById('confirm-cancel');

            messageElement.textContent = message;

            // 既存のリスナーを削除 (二重起動防止)
            okButton.onclick = null;
            cancelButton.onclick = null;

            // 「はい」ボタンのクリックイベントを設定
            okButton.onclick = () => {
                closeConfirmModal();
                onConfirm(); // 確定処理を実行
            };

            // 「いいえ」ボタンのクリックイベントを設定
            cancelButton.onclick = () => {
                closeConfirmModal();
                onCancel(); // キャンセル処理を実行
            };

            modal.style.display = 'flex';
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // -----------------------------------------------------
        // 6. データ検索モーダルロジック (#input-view 用)
        // -----------------------------------------------------

        function openSearchModal() {
            const modal = document.getElementById('search-modal');
            const resultsContainer = document.getElementById('modal-search-results');
            
            if (modal) {
                // 初期表示ではフォームの氏名を入力欄に設定
                document.getElementById('modal-search-input').value = document.getElementById('name').value;
                resultsContainer.innerHTML = '<p class="text-gray-500">氏名を入力して「検索」ボタンを押してください。</p>';
                modal.style.display = 'flex';
                // モーダル表示時に検索を実行
                searchModalData();
            }
        }

        function closeSearchModal() {
            const modal = document.getElementById('search-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function searchModalData() {
            const query = document.getElementById('modal-search-input').value.trim();
            const resultsContainer = document.getElementById('modal-search-results');
            
            let data = loadAllData();
            let results = data;

            if (query) {
                // 氏名(name)にキーワードが含まれるものをフィルタリング
                results = data.filter(item => item.name && item.name.includes(query));
            }
            
            // タイムスタンプで降順ソート
            results.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            displayModalResults(results, resultsContainer, query ? `"${query}"` : '全データ');
        }
        
        function displayModalResults(results, container, queryDescription) {
            container.innerHTML = ''; // 結果をクリア
            
            if (results.length === 0) {
                container.innerHTML = `<p class="text-gray-500">キーワード ${queryDescription} に該当するデータが見つかりませんでした。</p>`;
                return;
            }
            
            const resultWrapper = document.createElement('div');
            resultWrapper.classList.add('modal-search-result', 'data-grid-style', 'rounded-lg', 'shadow-md', 'mt-2');
            
            // モーダル用に表示項目を絞ったテーブルを生成
            const table = generateTableHTML(results, false, true); 
            resultWrapper.appendChild(table);
            
             // 件数を表示
            const countInfo = document.createElement('p');
            countInfo.classList.add('text-indigo-600', 'font-bold', 'mb-2', 'text-sm');
            countInfo.textContent = `${results.length} 件のデータが見つかりました。表示されている「ロード」ボタンを押すと、評価シートにデータが読み込まれます。`;
            container.appendChild(countInfo);
            container.appendChild(resultWrapper);
        }

        // IDを指定してデータをロードし、フォームに反映する
        function loadDataById(id) {
            let data = loadAllData();
            const selectedData = data.find(item => item.id === id);

            if (selectedData) {
                loadFormData(selectedData);
            } else {
                alertPlaceholder('データが見つかりませんでした。', 'red');
            }
        }


        // -----------------------------------------------------
        // 7. 初期化処理 (DOMロード後)
        // -----------------------------------------------------
        window.onload = function() {
            // 現在の日付を表示
            const today = new Date();
            const dateStr = today.getFullYear() + '.' + (today.getMonth() + 1).toString().padStart(2, '0') + '.' + today.getDate().toString().padStart(2, '0');
            const dateElement = document.getElementById('current-date-display');
            if (dateElement) {
                dateElement.textContent = 'Date: ' + dateStr;
            }

            // 初期ビューの設定
            showView('cover-view');
        };

    </script>
    
    <!-- ----------------------------------
         PWA/サービスワーカー登録用スクリプト
         ----------------------------------- -->
    <!-- app.jsは、このHTMLと同じルートフォルダに配置してください -->
    <script src="app.js"></script>

</body>
</html>